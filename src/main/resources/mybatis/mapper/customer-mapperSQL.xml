<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cust">

	<!-- 소속고객 전체 조회 쿼리 -->
	<select id="selectOwnCust" parameterType="Hashmap" resultType="cust">
		SELECT  
		    C.CUST_NO as custNo,
		    <!-- 고객이름 마킹처리 -->
		    CASE
		        WHEN LENGTH(C.CUST_NM)=2 THEN SUBSTR(C.CUST_NM,1,1)||LPAD('*',1)
		        WHEN LENGTH(C.CUST_NM)>=3 THEN SUBSTR(C.CUST_NM,1,1)||LPAD('*',LENGTH(C.CUST_NM)-2,'*')||SUBSTR(C.CUST_NM,LENGTH(C.CUST_NM),1)
		    END as custNm,
		    <!-- 휴대폰번호  하이픈,마킹처리 -->
		    CASE
		        WHEN LENGTH(C.MBL_NO)=10 THEN SUBSTR(C.MBL_NO,1,3)||'-***-'||SUBSTR(C.MBL_NO,7)
		        WHEN LENGTH(C.MBL_NO)=11 THEN SUBSTR(C.MBL_NO,1,3)||'-****-'||SUBSTR(C.MBL_NO,8)
		        ELSE '-'
		    END as mblNo,
		    <!-- 고객상태 변경 -->
		    CASE
		        WHEN C.CUST_SS_CD='10' THEN '정상'
		        WHEN C.CUST_SS_CD='80' THEN '중지'
		        WHEN C.CUST_SS_CD='90' THEN '해지'
		    END as custSsCd,
		    <!-- 가입일자 하이픈 삽입 -->
		    SUBSTR(C.JS_DT,1,4)||'-'||SUBSTR(C.JS_DT,5,2)||'-'||SUBSTR(C.JS_DT,7) as jsDt,
		    P.PRT_NM as jnPrtNm,
		    C.FST_USER_ID as fstUserId,
		    U.USER_NM as fstUserNm,
		    C.LST_UPD_DT as lstUpdDt,
		    C.LST_UPD_ID as lstUpdId
		FROM CS_CUST01_MT C
		LEFT JOIN MA_PRT_MT P ON (C.JN_PRT_CD=P.PRT_CD)
		LEFT JOIN MA_USER_MT U ON (C.FST_USER_ID=U.USER_ID)
		<!-- 특약점일 경우 초기세팅 -->
		<if test="userDtCd.equals(2)">
		    WHERE P.PRT_CD = #{prtCd}
		</if>
		ORDER BY 1
	</select>
	
	<!-- 거래처 전체 조회 쿼리 -->
	<select id="selectAllPrt" resultType="prt">
		SELECT 
		    PRT_CD as prtCd,
		    PRT_NM as prtNm,
		    CASE
		        WHEN PRT_SS_CD='10' THEN '정상'
		        WHEN PRT_SS_CD='80' THEN '거래중지'
		        WHEN PRT_SS_CD='90' THEN '해지'
		    END as prtSsCd
		FROM MA_PRT_MT
		WHERE PRT_DT_CD = 2
	</select>
	
	<!-- 거래처 검색 조회 쿼리 -->
	<select id="selectSearchPrt" parameterType="String" resultType="prt">
		SELECT 
		    PRT_CD as prtCd,
		    PRT_NM as prtNm,
		    CASE
		        WHEN PRT_SS_CD='10' THEN '정상'
		        WHEN PRT_SS_CD='80' THEN '거래중지'
		        WHEN PRT_SS_CD='90' THEN '해지'
		    END as prtSsCd
		FROM MA_PRT_MT
		WHERE (PRT_CD LIKE #{keyword} OR PRT_NM LIKE #{keyword}||'%') 
			  AND PRT_DT_CD = 2
	</select>
	
	<!-- 고객 전체 조회 쿼리 -->
	<select id="selectAllCust" resultType="cust">
		SELECT  
		    CUST_NO as custNo,
		    CUST_NM as custNm,
		    <!-- 휴대폰번호  하이픈처리 -->
		    CASE
		        WHEN LENGTH(MBL_NO)=10 THEN SUBSTR(MBL_NO,1,3)||'-'||SUBSTR(MBL_NO,4,3)||'-'||SUBSTR(MBL_NO,7)
      			WHEN LENGTH(MBL_NO)=11 THEN SUBSTR(MBL_NO,1,3)||'-'||SUBSTR(MBL_NO,4,4)||'-'||SUBSTR(MBL_NO,8)
		        ELSE '-'
		    END as mblNo,
		    <!-- 고객상태 변경 -->
		    CASE
		        WHEN CUST_SS_CD='10' THEN '정상'
		        WHEN CUST_SS_CD='80' THEN '중지'
		        WHEN CUST_SS_CD='90' THEN '해지'
		    END as custSsCd
		FROM CS_CUST01_MT
		ORDER BY 1
	</select>
	
	<!-- 고객 검색 조회 쿼리 -->
	<select id="selectSearchCust" parameterType="cust" resultType="cust">
		SELECT  
		    CUST_NO as custNo,
		    CUST_NM as custNm,
		    <!-- 휴대폰번호  하이픈처리 -->
		    CASE
		        WHEN LENGTH(MBL_NO)=10 THEN SUBSTR(MBL_NO,1,3)||'-'||SUBSTR(MBL_NO,4,3)||'-'||SUBSTR(MBL_NO,7)
      			WHEN LENGTH(MBL_NO)=11 THEN SUBSTR(MBL_NO,1,3)||'-'||SUBSTR(MBL_NO,4,4)||'-'||SUBSTR(MBL_NO,8)
		        ELSE '-'
		    END as mblNo,
		    <!-- 고객상태 변경 -->
		    CASE
		        WHEN CUST_SS_CD='10' THEN '정상'
		        WHEN CUST_SS_CD='80' THEN '중지'
		        WHEN CUST_SS_CD='90' THEN '해지'
		    END as custSsCd
		FROM CS_CUST01_MT
		WHERE 
		<!-- 검색내역이 비어있냐에 따라 따로 결과처리 -->
		<choose>
			<when test="mblNo.isEmpty()">
				CUST_NM LIKE '%'||#{custNm}||'%'
			</when>
			<when test="custNm.isEmpty()">
				MBL_NO = #{mblNo}
			</when>
			<otherwise>
				CUST_NM LIKE '%'||#{custNm}||'%' OR MBL_NO = #{mblNo}
			</otherwise>
		</choose>
		ORDER BY 1
	</select>
	
	<select id="selectCustNm" parameterType="String" resultType="String">
		SELECT CUST_NM as custNm 
		FROM CS_CUST01_MT 
		WHERE CUST_NO = #{custNo}
	</select>
	
	<!-- 고객이력 조회 쿼리 -->
	<select id="selectCustHt" parameterType="String" resultType="custHt">
		SELECT
		    H.CUST_NO as custNo,
		    C.CUST_Nm as custNm,
		    <!-- 변경일자 하이픈 삽입 -->
		    SUBSTR(H.CHG_DT,1,4)||'-'||SUBSTR(H.CHG_DT,5,2)||'-'||SUBSTR(H.CHG_DT,7) as chgDt,
		    <!-- 변경항목 변경 -->
		    CASE
		        WHEN H.CHG_CD='CUST_NO' THEN '고객번호'
		        WHEN H.CHG_CD='CUST_NM' THEN '고객이름'
		        WHEN H.CHG_CD='SEX_CD' THEN '성별코드'
		        WHEN H.CHG_CD='BRDY_DT' THEN '생년월일'
		        WHEN H.CHG_CD IN ('POC_CD','poc_cd') THEN '직업'
		        WHEN H.CHG_CD='MBL_NO' THEN '핸드폰번호'
		        WHEN H.CHG_CD IN ('CUST_SS_CD', 'cust_ss_cd') THEN '고객상태'
		        WHEN H.CHG_CD='JN_PRT_CD' THEN '가입매장'
		        WHEN H.CHG_CD='STP_DT' THEN '중지일자'
		        WHEN H.CHG_CD='CNCL_DT' THEN '해지일자'
		    END as chgCd,
		    <!-- 변경 전 내용 -->
		    CASE
		    	<!-- 성별 -->
		        WHEN H.CHG_BF_CNT='F' THEN '여자'
		        WHEN H.CHG_BF_CNT='M' THEN '남자'
		        <!-- 핸드폰번호('-'포함 생년월일 제외) -->
		        WHEN LENGTH(H.CHG_BF_CNT)=10 AND H.CHG_BF_CNT NOT LIKE '%-%' THEN SUBSTR(H.CHG_BF_CNT,1,3)||'-'||SUBSTR(H.CHG_BF_CNT,4,3)||'-'||SUBSTR(H.CHG_BF_CNT,7)
		      	WHEN LENGTH(H.CHG_BF_CNT)=11 THEN SUBSTR(H.CHG_BF_CNT,1,3)||'-'||SUBSTR(H.CHG_BF_CNT,4,4)||'-'||SUBSTR(H.CHG_BF_CNT,8)
		        <!-- 생년월일(가입매장제외) -->
		        WHEN LENGTH(H.CHG_BF_CNT)=8 AND H.CHG_BF_CNT NOT LIKE 'B%' THEN SUBSTR(H.CHG_BF_CNT,1,4)||'-'||SUBSTR(H.CHG_BF_CNT,5,2)||'-'||SUBSTR(H.CHG_BF_CNT,7)
		        <!-- 공백과 NULL값 처리 -->
		        WHEN H.CHG_BF_CNT IN (' ',' nullnull') THEN '-'
		        ELSE NVL(H.CHG_BF_CNT, '-')
		    END chgBfCnt,
		    <!-- 변경 후 내용 -->
		    CASE 
		    	<!-- 성별 -->
		        WHEN H.CHG_AFT_CNT='F' THEN '여자'
		        WHEN H.CHG_AFT_CNT='M' THEN '남자'
		        <!-- 핸드폰번호('-'포함 생년월일 제외) -->
		        WHEN LENGTH(H.CHG_AFT_CNT)=10 AND H.CHG_AFT_CNT NOT LIKE '%-%' THEN SUBSTR(H.CHG_AFT_CNT,1,3)||'-'||SUBSTR(H.CHG_AFT_CNT,4,3)||'-'||SUBSTR(H.CHG_AFT_CNT,7)
		      	WHEN LENGTH(H.CHG_AFT_CNT)=11 THEN SUBSTR(H.CHG_AFT_CNT,1,3)||'-'||SUBSTR(H.CHG_AFT_CNT,4,4)||'-'||SUBSTR(H.CHG_AFT_CNT,8)
		        <!-- 생년월일(가입매장제외) -->
		        WHEN LENGTH(H.CHG_AFT_CNT)=8 AND H.CHG_AFT_CNT NOT LIKE 'B%' THEN SUBSTR(H.CHG_AFT_CNT,1,4)||'-'||SUBSTR(H.CHG_AFT_CNT,5,2)||'-'||SUBSTR(H.CHG_AFT_CNT,7)
		        <!-- 공백과 NULL값 처리 -->
		        WHEN H.CHG_AFT_CNT IN (' ',' nullnull') THEN '-'
		        ELSE NVL(H.CHG_AFT_CNT, '-')
		    END chgAftCnt,
		    H.LST_UPD_ID as lstUpdId,
		    U.USER_NM as lstUpdNm,
		    H.LST_UPD_DT as lstUpdDt
		FROM SD_CUST01_HT H
		LEFT JOIN CS_CUST01_MT C ON (H.CUST_NO=C.CUST_NO)
		LEFT JOIN MA_USER_MT U ON (H.LST_UPD_ID=U.USER_ID)
		WHERE H.CUST_NO = #{custNo}
		ORDER BY 3 DESC
	</select>
</mapper>
