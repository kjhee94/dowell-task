<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "//mybatis.org/DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="sale">

	<!-- 고객 판매 조회 쿼리 -->
	<select id="selectSearchSale" parameterType="hashmap" resultType="sale">
		SELECT
			CASE                                                                                                            --가입일자(하이픈처리)
		        WHEN REGEXP_INSTR(S.SAL_DT,'[^0-9.]')=0 AND LENGTH(S.SAL_DT)=8												--가입일자가 숫자로 이루어진 8자리일 때 'YYYY-MM-DD'의 형식
		            THEN SUBSTR(S.SAL_DT,1,4)||'-'||SUBSTR(S.SAL_DT,5,2)||'-'||SUBSTR(S.SAL_DT,7)
		        ELSE '0000-00-00'                                                                                           --예외: '0000-00-00'의 형식으로 출력
		    END AS SALDT,
		    S.CUST_NO AS CUSTNO,
		    C.CUST_NM AS CUSTNM,
		    S.SAL_NO AS SALNO,
		    S.SAL_TP_CD AS SALTPCD,
		    S.PRT_CD AS PRTCD,
		    P.PRT_NM AS PRTNM,
		    CASE
		        WHEN S.SAL_DT = G.SAL_DT THEN G.TOT_SAL_QTY
		        ELSE 0
		    END AS TOTSALQTY,
		    CASE
		        WHEN S.SAL_DT = G.SAL_DT THEN TO_CHAR(G.TOT_SAL_AMT,'FM999,999,999')
		        ELSE '0'
		    END AS TOTSALAMT,
		    TO_CHAR(S.CSH_STLM_AMT,'FM999,999,999') AS CSHSTLMAMT,
		    TO_CHAR(S.CRD_STLM_AMT,'FM999,999,999') AS CRDSTLMAMT,
		    TO_CHAR(S.PNT_STLM_AMT,'FM999,999,999') AS PNTSTLMAMT,
		    U.USER_NM AS FSTUSERNM,
		    TO_CHAR(S.FST_REG_DT,'YYYY-MM-DD') AS FSTREGDTFM
		FROM CS_SAL01_MT S
		    LEFT JOIN CS_CUST01_MT C ON (S.CUST_NO=C.CUST_NO)
		    LEFT JOIN MA_PRT_MT P ON (S.PRT_CD=P.PRT_CD)
		    LEFT JOIN MA_USER_MT U ON (S.FST_USER_ID=U.USER_ID) 
		    LEFT JOIN (SELECT SAL_DT, SAL_NO, SUM(SAL_QTY) AS TOT_SAL_QTY, SUM(SAL_AMT) AS TOT_SAL_AMT
		                FROM CS_SAL01_DT
		                WHERE PRT_CD=#{prtCd}
		                GROUP BY SAL_DT, SAL_NO) G ON (S.SAL_DT = G.SAL_DT AND S.SAL_NO = G.SAL_NO)
		WHERE (S.SAL_DT BETWEEN TO_DATE(#{salDtFrom}) AND TO_DATE(#{salDtTo}))
		    AND S.PRT_CD=#{prtCd}
		    <if test="custNo!=null and !custNo.isEmpty()">
		    AND S.CUST_NO=#{custNo}
		    </if>
		ORDER BY 1 DESC, 4 DESC
	</select>
	
	<!-- 고객상태 조회 쿼리 -->
	<select id="selectCustSs" resultType="cust">
		SELECT DTL_CD AS CUSTSSCD, 		--세부코드
			   DTL_CD_NM AS CUSTSSNM	--세부코드명
		FROM MA_CODE_DT 				--코드상세 테이블
		WHERE CODE_CD='CUST_SS_CD'		--공통코드가 'CUST_SS_CD'인 것만 조회
	</select>
	
	<!-- 판매구분 조회 쿼리 -->
	<select id="selectSalTp" resultType="sale">
		SELECT DTL_CD AS SALTPCD, 	--세부코드
			   DTL_CD_NM AS SALTPNM	--세부코드명
		FROM MA_CODE_DT 			--코드상세 테이블
		WHERE CODE_CD='SAL_TP_CD'	--공통코드가 'SAL_TP_CD'인 것만 조회
		ORDER BY 1 DESC
	</select>
	
	<!-- 카드회사 조회 쿼리 -->
	<select id="selectCrdCo" resultType="sale">
		SELECT DTL_CD AS CRDCOCD, 	--세부코드
			   DTL_CD_NM AS CRDCONM	--세부코드명
		FROM MA_CODE_DT 			--코드상세 테이블
		WHERE CODE_CD='CRD_CO_CD'	--공통코드가 'CRD_CO_CD'인 것만 조회
	</select>
	
	<!-- 매장 재고 조회 쿼리 -->
	<select id="selectPrd" parameterType="hashmap" resultType="saleDt">
		SELECT 
		    P.PRD_CD AS PRDCD,
		    P.PRD_NM AS PRDNM,
		    I.IVCO_QTY AS IVCOQTY,
		    TO_CHAR(P.PRD_CSMR_UPR,'FM999,999,999') AS PRDCSMRUPR,
		    P.PRD_SS_CD AS PRDSSCD
		FROM SD_IVCO01_MT I
		    LEFT JOIN MA_PRD01_MT P ON (I.PRD_CD=P.PRD_CD)
		WHERE P.PRD_TP_CD='10'
		    AND PRT_CD=#{prtCd}
		    AND (P.PRD_CD LIKE '%'||#{keyword}||'%' OR P.PRD_NM LIKE '%'||#{keyword}||'%')
	</select>
		
	<!-- 판매 상세 조회 쿼리 -->
	<select id="selectSaleDt" parameterType="hashmap" resultType="saleDt">
		SELECT 
		    ROW_NUMBER() OVER(ORDER BY SAL_SEQ DESC) SEQNUM,
		    S.PRD_CD AS PRDCD,
		    P.PRD_NM AS PRDNM,
		    S.SAL_QTY AS SALQTY,
		    TO_CHAR(S.SAL_VOS_AMT,'FM999,999,999')AS SALVOSAMT,
		    TO_CHAR(S.SAL_VAT_AMT,'FM999,999,999') AS SALVATAMT,
		    TO_CHAR(S.SAL_AMT,'FM999,999,999') AS SALAMT
		FROM CS_SAL01_DT S
		    LEFT JOIN MA_PRD01_MT P ON (S.PRD_CD=P.PRD_CD)
		WHERE PRT_CD=#{prtCd} 
		    AND SAL_DT=#{salDt}
		    AND SAL_NO=#{salNo}
		ORDER BY SAL_SEQ DESC
	</select>
	
	<!-- 반품할 고객 판매 조회  쿼리 -->
	<select id="selectOneSale" parameterType="hashmap" resultType="sale">
		SELECT
			PRT_CD AS PRTCD,
			SAL_NO AS SALNO,
		    TOT_SAL_QTY AS TOTSALQTY,
		    TOT_SAL_AMT AS TOTSALAMT,
		    TOT_VOS_AMT AS TOTVOSAMT,
		    TOT_VAT_AMT AS TOTVATAMT,
		    CSH_STLM_AMT AS CSHSTLMAMT,
		    CRD_STLM_AMT AS CRDSTLMAMT,
		    PNT_STLM_AMT AS PNTSTLMAMT,
		    CUST_NO AS CUSTNO,
		    CRD_NO AS CRDNO,
		    VLD_YM AS VLDYM,
		    CRD_CO_CD AS CRDCOCD
		FROM CS_SAL01_MT
		WHERE PRT_CD=#{prtCd}
		    AND SAL_DT=#{salDt}
		    AND SAL_NO=#{salNo}
	</select>
	
	<!-- 반품 등록 쿼리 -->
	<insert id="insertRtn" parameterType="hashmap">
		<foreach collection="slist" item="item" open="INSERT ALL" separator="" close="SELECT * FROM DUAL">
			INTO CS_SAL01_MT 
			    (PRT_CD, 
			     SAL_DT, 
			     SAL_NO, 
			     SAL_TP_CD, 
			     TOT_SAL_QTY,
			     TOT_SAL_AMT, 
			     TOT_VOS_AMT, 
			     TOT_VAT_AMT, 
			     CSH_STLM_AMT, 
			     CRD_STLM_AMT, 
			     PNT_STLM_AMT, 
			     CUST_NO, 
			     CRD_NO, 
			     VLD_YM, 
			     CRD_CO_CD, 
			     FST_REG_DT,
			     FST_USER_ID,
			     LST_UPD_DT,
			     LST_UPD_ID)
			VALUES 
			    (#{item.prtCd},                 																					--매장코드
			     TO_CHAR(SYSDATE,'YYYYMMDD'),   																					--판매일자(오늘)
			     (SELECT NVL(MAX(SAL_NO),0)+1 FROM CS_SAL01_MT WHERE PRT_CD=#{item.prtCd} AND SAL_DT=TO_CHAR(SYSDATE,'YYYYMMDD')), --판매번호(스칼라쿼리_현매장,변경일자현재로 조회)
			     'RTN',                         																					--판매구분코드
			     #{item.totSalQty},            																						--총판매수량
			     #{item.totSalAmt},            																						--총판매금액
			     #{item.totVosAmt},            																						--총공급가액
			     #{item.totVatAmt},            																						--총부가세액
			     #{item.cshStlmAmt},           																						--현금결제금액
			     #{item.crdStlmAmt},           																						--카드결제금액
			     #{item.pntStlmAmt},           																						--포인트사용금액
			     #{item.custNo},               																						--고객번호
			     #{item.crdNo, jdbcType=VARCHAR},                																						--카드번호
			     #{item.vldYm, jdbcType=VARCHAR},                																						--유효년월
			     #{item.crdCoCd, jdbcType=VARCHAR},              																						--카드회사
			     SYSDATE,             																								--최초등록일
			     #{userId},            																								--최초등록자
			     SYSDATE,                       																					--최종수정일
			     #{userId}                      																					--최종수정자
			     )
		</foreach>
	</insert>
	
	<!-- 반품할 판매 상세 조회 쿼리  -->
	<select id="selectOneSaleDt" parameterType="hashmap" resultType="saleDt">
		SELECT 
		    PRT_CD AS PRTCD,
		    SAL_DT AS SALDT,
		    SAL_NO AS SALNO,
		    SAL_SEQ AS SALSEQ,
		    PRD_CD AS PRDCD,
		    PRD_CSMR_UPR AS PRDCSMRUPR,
		    SAL_QTY AS SALQTY,
		    SAL_AMT AS SALAMT,
		    SAL_VOS_AMT AS SALVOSAMT,
		    SAL_VAT_AMT AS SALVATAMT,
		    FST_REG_DT AS FSTREGDT,
		    FST_USER_ID AS FSTUSERID,
		    LST_UPD_DT AS LSTUPDDT,
		    LST_UPD_ID AS LSTUPDID
		FROM CS_SAL01_DT 
		WHERE PRT_CD=#{prtCd}
		    AND SAL_DT=#{salDt}
		    AND SAL_NO=#{salNo}
		ORDER BY SAL_SEQ
	</select>
	
	<!-- 판매 상세 등록 쿼리 -->
	<insert id="insertRtnDt" parameterType="hashmap">
		<foreach collection="sdlist" item="item" index="index" open="INSERT ALL" separator="" close="SELECT * FROM DUAL">
			INTO CS_SAL01_DT
				(PRT_CD,
			     SAL_DT,
			     SAL_NO,
			     SAL_SEQ,
			     PRD_CD,
			     PRD_CSMR_UPR,
			     SAL_QTY,
			     SAL_AMT,
			     SAL_VOS_AMT,
			     SAL_VAT_AMT,
			     FST_REG_DT,
			     FST_USER_ID,
			     LST_UPD_DT,
			     LST_UPD_ID)
			VALUES 
				(#{item.prtCd},																										--고객번호
				 TO_CHAR(SYSDATE,'YYYYMMDD'),																						--변경일자(오늘)
				 (SELECT NVL(MAX(SAL_NO),0)+1 FROM CS_SAL01_MT WHERE PRT_CD=#{item.prtCd} AND SAL_DT=TO_CHAR(SYSDATE,'YYYYMMDD')),	--일련변호((이전 일련번호+1)+index)
				 #{index}+1,																										--변경코드
				 #{item.prdCd},																										--변경 전 내용
				 #{item.prdCsmrUpr},																								--변경 후 내용
				 #{item.salQty},																									--변경 후 내용				 
				 #{item.salAmt},																									--변경 후 내용				 
				 #{item.salVosAmt},																									--변경 후 내용				 
				 #{item.salVatAmt},																									--변경 후 내용			 
				 SYSDATE,																											--최초등록일자 (sysdate)
				 #{userId}, 																										--최초등록자(세션 아이디)
				 SYSDATE,																											--최종수정일자(sysdate)
				 #{userId})																											--최종수정자(세션아이디)
  		</foreach>
	</insert>
	
	<!-- 현재고 수정 쿼리 -->
	<update id="updateIvco">
		<foreach collection="sdlist" item="item" separator=";" open="DECLARE BEGIN" close="; END;">
			UPDATE SD_IVCO01_MT
			SET IVCO_QTY=(SELECT IVCO_QTY 
						  FROM SD_IVCO01_MT 
						  WHERE PRT_CD=#{item.prtCd} 
						  	AND PRD_CD=#{item.prdCd})-#{item.salQty}
			WHERE PRT_CD=#{item.prtCd}
			    AND PRD_CD=#{item.prdCd}
		</foreach>
	</update>
</mapper>
